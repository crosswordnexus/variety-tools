<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Create shareable variety puzzle link</title>

  <!-- Simple.css -->
  <link rel="stylesheet" href="https://cdn.simplecss.org/simple.min.css" />

  <!-- Image compression -->
  <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>

  <style>
    form label {
      display: block;
      margin-bottom: 1rem;
    }

    form label input,
    form label textarea,
    form label select {
      display: block;
      width: 100%;
      margin-top: 0.3rem;
    }

    form label:has(input[type="checkbox"]) {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      width: auto;
      margin-bottom: 1rem;
    }

    form label:has(input[type="checkbox"]) input[type="checkbox"] {
      width: auto;
      display: inline-block;
      margin-top: 0;
    }

    .clue-group {
      border: 1px solid var(--accent);
      padding: 1rem;
      margin-bottom: 1rem;
      border-radius: 0.5rem;
    }

    .clue-list input {
      width: 48%;
      margin: 0.25rem 1% 0.25rem 0;
      display: inline-block;
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>

<body>
  <header>
    <h1>vPuz File Creator</h1>
    <p>Fill out the fields below to create a vPuz JSON puzzle.
      The image and at least one clue list are required.</p>
  </header>

  <main>
    <form id="vpuzForm">
      <h2>Metadata</h2>

      <label>Title <input type="text" id="title" /></label>
      <label>Author <input type="text" id="author" /></label>
      <label>Copyright <input type="text" id="copyright" value="Â©" /></label>
      <label>Notes <textarea id="notes" rows="4"></textarea></label>

      <label for="solution">Solution</label>
      <textarea id="solution" rows="3" placeholder="Enter the solution string here..."></textarea>
      <small><em>
          Enter the letters that make up your solution here.
          If a solver enters these letters into the grid in any arrangement,
          the puzzle will be marked as correctly solved.
        </em></small>

      <h2>Puzzle Image</h2>
      <label><input type="file" id="puzzleImage" accept="image/*" /></label>

      <label>
        <input type="checkbox" id="uploadToImgBB" />
        Upload to imgbb (for shorter links)
      </label>
      <small>Your upload to imgbb will be anonymous, if you choose to go that route.</small>

      <h2>Clues</h2>
      <div id="clueGroups"></div>
      <button type="button" id="addClueGroup">+ Add Clue Group</button>

      <hr />

      <div style="text-align:center">
        <button type="button" id="generateShareLink">Generate Shareable Link</button>
      </div>

      <div id="results" class="hidden">
        <h3>Shareable Link:</h3>
        <textarea id="shareLink" rows="2" readonly></textarea>
        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
          <button type="button" id="copyLink">Copy Link</button>
          <button type="button" id="shortenLink">Shorten URL (da.gd)</button>
        </div>
        <p id="status" style="font-style: italic; margin-top: 0.5rem;"></p>
      </div>

    </form>
  </main>

  <!-- LZString -->
  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>

  <script>
    // ----- Helpers -----
    function readImageAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = e => reject(e);
        reader.readAsDataURL(file);
      });
    }

    async function uploadToImgbb(file) {
      const apiKey = "a360bbf432382bc636147693dd06d804"; // from imgbb.com

      // --- Compress before uploading ---
      const options = {
        maxWidthOrHeight: 750,
        maxSizeMB: 0.1, // 100 KB target
        useWebWorker: true,
        initialQuality: 0.8,
      };
      const compressed = await imageCompression(file, options);

      const formData = new FormData();
      formData.append("image", compressed);

      const response = await fetch(`https://api.imgbb.com/1/upload?key=${apiKey}`, {
        method: "POST",
        body: formData,
      });

      const json = await response.json();
      if (!json.success) throw new Error("imgbb upload failed");
      return json.data.url; // e.g., https://i.ibb.co/abc123.png
    }

    // ----- Clue group UI -----
    const clueGroupsDiv = document.getElementById("clueGroups");
    document.getElementById("addClueGroup").addEventListener("click", () => {
      const wrapper = document.createElement("div");
      wrapper.className = "clue-group";

      const groupLabel = document.createElement("input");
      groupLabel.placeholder = "Clue group name (e.g., Clockwise)";
      groupLabel.className = "group-name";
      wrapper.appendChild(groupLabel);

      const clueList = document.createElement("div");
      clueList.className = "clue-list";
      wrapper.appendChild(clueList);

      const addClueBtn = document.createElement("button");
      addClueBtn.type = "button";
      addClueBtn.textContent = "+ Add Clue";
      addClueBtn.addEventListener("click", () => {
        const numInput = document.createElement("input");
        numInput.placeholder = "Number";
        const textInput = document.createElement("input");
        textInput.placeholder = "Clue text";
        clueList.appendChild(numInput);
        clueList.appendChild(textInput);
      });
      wrapper.appendChild(addClueBtn);

      clueGroupsDiv.appendChild(wrapper);
    });

    // ----- Share link logic -----
    const results = document.getElementById("results");
    const shareLink = document.getElementById("shareLink");
    const copyLinkBtn = document.getElementById("copyLink");
    const status = document.getElementById("status");
    const shortenLinkBtn = document.getElementById("shortenLink");

    // --- Shorten URL using da.gd API ---
    shortenLinkBtn.addEventListener("click", async () => {
      const longUrl = shareLink.value.trim();
      if (!longUrl) {
        status.textContent = "Please generate a link first.";
        return;
      }

      try {
        status.textContent = "Shortening link...";
        const response = await fetch(`https://da.gd/shorten?url=${encodeURIComponent(longUrl)}`);
        const shortUrl = (await response.text()).trim();

        if (!shortUrl || shortUrl.startsWith("Error")) {
          throw new Error(shortUrl || "da.gd returned an error.");
        }

        shareLink.value = shortUrl;
        status.textContent = "Shortened successfully!";
      } catch (err) {
        console.error(err);
        status.textContent = "Failed to shorten link.";
      }
    });

    copyLinkBtn.addEventListener("click", () => {
      navigator.clipboard.writeText(shareLink.value);
      copyLinkBtn.textContent = "Copied!";
      setTimeout(() => (copyLinkBtn.textContent = "Copy Link"), 1500);
    });

    document.getElementById("generateShareLink").addEventListener("click", async () => {
      const title = document.getElementById("title").value.trim();
      const author = document.getElementById("author").value.trim();
      const copyright = document.getElementById("copyright").value.trim();
      const notes = document.getElementById("notes").value.trim();
      const solution = document.getElementById("solution").value.trim();
      const imageFile = document.getElementById("puzzleImage").files[0];

      if (!imageFile) {
        alert("Please select a puzzle image.");
        return;
      }

      // gather clues
      const cluesObj = {};
      document.querySelectorAll(".clue-group").forEach((g) => {
        const name = g.querySelector(".group-name").value.trim();
        if (!name) return;
        const clues = [];
        const inputs = g.querySelectorAll(".clue-list input");
        for (let i = 0; i < inputs.length; i += 2) {
          const num = inputs[i].value.trim();
          const clue = inputs[i + 1]?.value.trim() || "";
          if (num && clue) clues.push([num, clue]);
        }
        if (clues.length > 0) cluesObj[name] = clues;
      });
      if (Object.keys(cluesObj).length === 0) {
        alert("Please add at least one clue list with clues.");
        return;
      }

      try {
        let imageField;
        if (document.getElementById("uploadToImgBB").checked) {
          status.textContent = "Uploading image to imgbb...";
          imageField = await uploadToImgbb(imageFile);
        } else {
          imageField = await readImageAsDataURL(imageFile);
        }

        const vpuz = {
          author,
          title,
          copyright,
          notes,
          "solution-string": solution,
          clues: cluesObj,
          "puzzle-image": imageField,
        };

        const encoded = LZString.compressToEncodedURIComponent(JSON.stringify(vpuz));
        const basePath = window.location.pathname.replace(/[^/]+$/, "");
        const baseUrl = `${window.location.origin}${basePath}`;
        const playUrl = `${baseUrl}index.html#${encoded}`;

        shareLink.value = playUrl;
        results.classList.remove("hidden");
        results.scrollIntoView({
          behavior: "smooth"
        });
        status.textContent = "";
      } catch (err) {
        console.error(err);
        status.textContent = "Error generating link.";
      }
    });
  </script>
</body>

</html>
